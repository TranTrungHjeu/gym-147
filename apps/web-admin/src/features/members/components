import React, { useState } from 'react';
import { MemberService } from '../services/member.service';

interface MemberForm {
  full_name: string;
  email: string;
  phone: string;
  date_of_birth: string;
  gender: 'MALE' | 'FEMALE' | 'OTHER';
  address: string;
  emergency_contact: string;
  membership_type: string;
}

const MemberManagement: React.FC = () => {
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [memberForm, setMemberForm] = useState<MemberForm>({
    full_name: '',
    email: '',
    phone: '',
    date_of_birth: '',
    gender: 'MALE',
    address: '',
    emergency_contact: '',
    membership_type: 'BASIC',
  });

  const [selectedMemberId, setSelectedMemberId] = useState('');

  const handleInputChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>
  ) => {
    const { name, value } = e.target;
    setMemberForm(prev => ({
      ...prev,
      [name]: value,
    }));
  };

  const createMember = async () => {
    try {
      setLoading(true);
      setMessage(null);

      // Temporary: Generate user_id for testing (bypass Identity Service)
      const tempUserId = `USER_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;

      setMessage('Creating member profile...');
      const memberData = {
        ...memberForm,
        user_id: tempUserId,
      };

      const response = await MemberService.createMember(memberData);
      setMessage(`Member created successfully! User ID: ${tempUserId}, Member ID: ${response.id}`);

      // Reset form
      setMemberForm({
        full_name: '',
        email: '',
        phone: '',
        date_of_birth: '',
        gender: 'MALE',
        address: '',
        emergency_contact: '',
        membership_type: 'BASIC',
      });
    } catch (error: any) {
      setMessage(`Error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const createSampleData = async () => {
    try {
      setLoading(true);
      setMessage('Creating sample members...');

      const sampleMembers = [
        {
          full_name: 'Nguyen Van A',
          email: 'nguyenvana@example.com',
          phone: '0901234567',
          date_of_birth: '1990-01-15',
          gender: 'MALE' as const,
          address: '123 Le Loi Street, Ho Chi Minh City',
          emergency_contact: '0987654321',
          membership_type: 'PREMIUM',
        },
        {
          full_name: 'Tran Thi B',
          email: 'tranthib@example.com',
          phone: '0912345678',
          date_of_birth: '1992-05-20',
          gender: 'FEMALE' as const,
          address: '456 Nguyen Trai Street, Ho Chi Minh City',
          emergency_contact: '0976543210',
          membership_type: 'BASIC',
        },
        {
          full_name: 'Le Van C',
          email: 'levanc@example.com',
          phone: '0923456789',
          date_of_birth: '1988-11-10',
          gender: 'MALE' as const,
          address: '789 Hai Ba Trung Street, Ho Chi Minh City',
          emergency_contact: '0965432109',
          membership_type: 'VIP',
        },
        {
          full_name: 'Pham Thi D',
          email: 'phamthid@example.com',
          phone: '0934567890',
          date_of_birth: '1995-07-25',
          gender: 'FEMALE' as const,
          address: '321 Vo Thi Sau Street, Ho Chi Minh City',
          emergency_contact: '0954321098',
          membership_type: 'BASIC',
        },
        {
          full_name: 'Hoang Van E',
          email: 'hoangvane@example.com',
          phone: '0945678901',
          date_of_birth: '1987-03-08',
          gender: 'MALE' as const,
          address: '654 Cong Quynh Street, Ho Chi Minh City',
          emergency_contact: '0943210987',
          membership_type: 'PREMIUM',
        },
      ];

      let createdCount = 0;
      for (const member of sampleMembers) {
        try {
          setMessage(`Creating member profile for ${member.full_name}...`);

          // Temporary: Generate user_id for testing (bypass Identity Service)
          const tempUserId = `USER_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;

          const memberData = {
            ...member,
            user_id: tempUserId,
          };

          await MemberService.createMember(memberData);
          createdCount++;
        } catch (error) {
          console.error('Error creating member:', error);
        }
      }

      setMessage(`Successfully created ${createdCount} sample members!`);
    } catch (error: any) {
      setMessage(`Error creating sample data: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const checkInMember = async () => {
    if (!selectedMemberId) {
      setMessage('Please enter a member ID');
      return;
    }

    try {
      setLoading(true);
      const response = await MemberService.checkInMember(selectedMemberId);
      setMessage(
        `Member checked in successfully at ${new Date(response.accessLog.entry_time).toLocaleString()}`
      );
    } catch (error: any) {
      setMessage(`Check-in error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const checkOutMember = async () => {
    if (!selectedMemberId) {
      setMessage('Please enter a member ID');
      return;
    }

    try {
      setLoading(true);
      const response = await MemberService.checkOutMember(selectedMemberId);
      setMessage(
        `Member checked out successfully. Duration: ${response.accessLog.duration_minutes} minutes`
      );
    } catch (error: any) {
      setMessage(`Check-out error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const createMembership = async () => {
    if (!selectedMemberId) {
      setMessage('Please enter a member ID');
      return;
    }

    try {
      setLoading(true);
      const membershipData = {
        type: 'PREMIUM',
        duration_months: 3,
        price: 1500000,
      };

      const response = await MemberService.createMembership(selectedMemberId, membershipData);
      setMessage(
        `Membership created successfully! Valid until ${new Date(response.membership.end_date).toLocaleDateString()}`
      );
    } catch (error: any) {
      setMessage(`Membership creation error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className='p-6 max-w-4xl mx-auto space-y-6'>
      <h2 className='text-2xl font-bold mb-6'>Member Management & Testing</h2>

      {message && (
        <div
          className={`p-4 rounded-md ${message.includes('Error') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}
        >
          {message}
        </div>
      )}

      {/* Quick Actions */}
      <div className='bg-white p-6 rounded-lg shadow-md'>
        <h3 className='text-lg font-semibold mb-4'>Quick Actions</h3>
        <div className='space-y-4'>
          <button
            onClick={createSampleData}
            disabled={loading}
            className='bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50'
          >
            {loading ? 'Creating...' : 'Create Sample Members'}
          </button>
        </div>
      </div>

      {/* Create New Member */}
      <div className='bg-white p-6 rounded-lg shadow-md'>
        <h3 className='text-lg font-semibold mb-4'>Create New Member</h3>
        <div className='grid grid-cols-1 md:grid-cols-2 gap-4'>
          <div>
            <label className='block text-sm font-medium text-gray-700 mb-1'>Full Name</label>
            <input
              type='text'
              name='full_name'
              value={memberForm.full_name}
              onChange={handleInputChange}
              className='w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
              placeholder='Enter full name'
            />
          </div>

          <div>
            <label className='block text-sm font-medium text-gray-700 mb-1'>Email</label>
            <input
              type='email'
              name='email'
              value={memberForm.email}
              onChange={handleInputChange}
              className='w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
              placeholder='Enter email'
            />
          </div>

          <div>
            <label className='block text-sm font-medium text-gray-700 mb-1'>Phone</label>
            <input
              type='tel'
              name='phone'
              value={memberForm.phone}
              onChange={handleInputChange}
              className='w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
              placeholder='Enter phone number'
            />
          </div>

          <div>
            <label className='block text-sm font-medium text-gray-700 mb-1'>Date of Birth</label>
            <input
              type='date'
              name='date_of_birth'
              value={memberForm.date_of_birth}
              onChange={handleInputChange}
              className='w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
            />
          </div>

          <div>
            <label className='block text-sm font-medium text-gray-700 mb-1'>Gender</label>
            <select
              name='gender'
              value={memberForm.gender}
              onChange={handleInputChange}
              className='w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
            >
              <option value='MALE'>Male</option>
              <option value='FEMALE'>Female</option>
              <option value='OTHER'>Other</option>
            </select>
          </div>

          <div>
            <label className='block text-sm font-medium text-gray-700 mb-1'>Membership Type</label>
            <select
              name='membership_type'
              value={memberForm.membership_type}
              onChange={handleInputChange}
              className='w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
            >
              <option value='BASIC'>Basic</option>
              <option value='PREMIUM'>Premium</option>
              <option value='VIP'>VIP</option>
            </select>
          </div>

          <div className='md:col-span-2'>
            <label className='block text-sm font-medium text-gray-700 mb-1'>Address</label>
            <textarea
              name='address'
              value={memberForm.address}
              onChange={handleInputChange}
              rows={3}
              className='w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
              placeholder='Enter address'
            />
          </div>

          <div className='md:col-span-2'>
            <label className='block text-sm font-medium text-gray-700 mb-1'>
              Emergency Contact
            </label>
            <input
              type='tel'
              name='emergency_contact'
              value={memberForm.emergency_contact}
              onChange={handleInputChange}
              className='w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
              placeholder='Enter emergency contact'
            />
          </div>
        </div>

        <button
          onClick={createMember}
          disabled={loading}
          className='mt-4 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 disabled:opacity-50'
        >
          {loading ? 'Creating...' : 'Create Member'}
        </button>
      </div>

      {/* Member Operations */}
      <div className='bg-white p-6 rounded-lg shadow-md'>
        <h3 className='text-lg font-semibold mb-4'>Member Operations</h3>
        <div className='space-y-4'>
          <div>
            <label className='block text-sm font-medium text-gray-700 mb-1'>Member ID</label>
            <input
              type='text'
              value={selectedMemberId}
              onChange={e => setSelectedMemberId(e.target.value)}
              className='w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
              placeholder='Enter member ID for operations'
            />
          </div>

          <div className='flex flex-wrap gap-2'>
            <button
              onClick={checkInMember}
              disabled={loading || !selectedMemberId}
              className='bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50'
            >
              Check In
            </button>

            <button
              onClick={checkOutMember}
              disabled={loading || !selectedMemberId}
              className='bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 disabled:opacity-50'
            >
              Check Out
            </button>

            <button
              onClick={createMembership}
              disabled={loading || !selectedMemberId}
              className='bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 disabled:opacity-50'
            >
              Create Membership
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default MemberManagement;
