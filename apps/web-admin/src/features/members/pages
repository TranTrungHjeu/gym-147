import React, { useEffect, useState } from 'react';
import {
  AlertTriangle,
  Edit3,
  Mail,
  Phone,
  Search,
  Trash2,
  Users2,
} from 'lucide-react';
import { Button, Card, IconBadge, Input } from '../components';
import { Member, MemberService, MemberStats, PaginationResult } from '../services/member.service';

export default function Members() {
  const [membersData, setMembersData] = useState<PaginationResult<Member> | null>(null);
  const [stats, setStats] = useState<MemberStats | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [page, setPage] = useState(1);
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('');

  const fetchMembers = async () => {
    try {
      setLoading(true);
      setError(null);

      const response = await MemberService.getMembers({
        page,
        limit: 20,
        search,
        status: statusFilter,
      });

      setMembersData(response);
    } catch (err: any) {
      setError(err.message || 'Failed to fetch members');
      console.error('Error fetching members:', err);
    } finally {
      setLoading(false);
    }
  };

  const fetchStats = async () => {
    try {
      const statsResponse = await MemberService.getMemberStats();
      setStats(statsResponse);
    } catch (err) {
      console.error('Error fetching stats:', err);
    }
  };

  useEffect(() => {
    fetchMembers();
  }, [page, search, statusFilter]);

  useEffect(() => {
    fetchStats();
  }, []);

  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault();
    setPage(1);
    fetchMembers();
  };

  const totalMembers = membersData?.pagination?.total ?? 0;
  const totalPages = Math.max(membersData?.pagination?.totalPages ?? 1, 1);

  return (
    <div className='space-y-8 text-brand-50'>
      <div className='flex flex-col justify-between gap-4 sm:flex-row sm:items-center'>
        <div>
          <div className='flex items-center gap-3'>
            <IconBadge icon={Users2} tone='brand' />
            <h1 className='text-3xl font-semibold tracking-wide'>Quản lý hội viên</h1>
          </div>
          <p className='mt-2 text-sm text-ink-300'>Theo dõi danh sách hội viên, trạng thái gói tập và thông tin liên hệ.</p>
        </div>
        <div className='rounded-2xl border border-brand-500/30 bg-brand-500/10 px-4 py-2 text-sm text-brand-100'>
          {totalMembers} kết quả · Trang {page}/{totalPages}
        </div>
      </div>

      {error && (
        <Card className='border border-red-500/40 bg-red-500/10 text-red-200'>
          <div className='flex items-center gap-3'>
            <AlertTriangle className='h-5 w-5' strokeWidth={1.6} />
            <span>{error}</span>
          </div>
        </Card>
      )}

      {stats && (
        <div className='grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-4'>
          {[{
            label: 'Tổng hội viên',
            value: stats.total,
            tone: 'brand' as const,
          },
          {
            label: 'Đang hoạt động',
            value: stats.active,
            tone: 'success' as const,
          },
          {
            label: 'Hết hạn',
            value: stats.expired,
            tone: 'warning' as const,
          },
          {
            label: 'Mới trong tháng',
            value: stats.newThisMonth,
            tone: 'info' as const,
          }].map(item => (
            <Card key={item.label} className='border border-white/10'>
              <div className='flex items-center justify-between'>
                <div>
                  <p className='text-xs uppercase tracking-[0.2em] text-ink-400'>{item.label}</p>
                  <p className='mt-3 text-3xl font-semibold text-brand-50'>{item.value}</p>
                </div>
                <IconBadge icon={Users2} tone={item.tone} />
              </div>
            </Card>
          ))}
        </div>
      )}

      <Card className='border border-white/10'>
        <form onSubmit={handleSearch} className='grid grid-cols-1 gap-4 md:grid-cols-[1fr_auto] md:items-end'>
          <div className='grid grid-cols-1 gap-4 lg:grid-cols-[1fr_auto]'>
            <div className='space-y-2'>
              <label className='flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-ink-400'>
                <Search className='h-4 w-4 text-brand-300' strokeWidth={1.6} />
                Tìm kiếm hội viên
              </label>
              <Input
                placeholder='Nhập tên, email hoặc số điện thoại...'
                value={search}
                onChange={e => setSearch(e.target.value)}
                fullWidth
              />
            </div>
            <div className='space-y-2'>
              <label className='flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-ink-400'>
                Trạng thái
              </label>
              <select
                value={statusFilter}
                onChange={e => setStatusFilter(e.target.value)}
                className='w-full rounded-xl border border-white/10 bg-surface-900/60 px-4 py-3 text-brand-50 outline-none transition-colors hover:border-brand-500/40 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/40'
              >
                <option className='bg-surface-900' value=''>Tất cả</option>
                <option className='bg-surface-900' value='ACTIVE'>Đang hoạt động</option>
                <option className='bg-surface-900' value='EXPIRED'>Hết hạn</option>
                <option className='bg-surface-900' value='SUSPENDED'>Tạm dừng</option>
              </select>
            </div>
          </div>
          <div className='flex items-end justify-end'>
            <Button type='submit' variant='primary'>
              Tìm kiếm
            </Button>
          </div>
        </form>
      </Card>

      <Card className='border border-white/10'>
        {loading ? (
          <div className='flex min-h-[280px] items-center justify-center text-ink-300'>
            Đang tải dữ liệu hội viên...
          </div>
        ) : !membersData?.items?.length ? (
          <div className='flex min-h-[240px] flex-col items-center justify-center gap-3 text-ink-300'>
            <IconBadge icon={Users2} tone='neutral' />
            <p className='text-base font-semibold text-brand-50'>Chưa có dữ liệu hội viên</p>
            <p className='text-sm text-ink-400'>
              {search || statusFilter
                ? 'Hãy thử điều chỉnh điều kiện lọc hoặc từ khóa tìm kiếm.'
                : 'Thêm hội viên mới để bắt đầu quản lý.'}
            </p>
          </div>
        ) : (
          <div className='-mx-6 overflow-x-auto'>
            <table className='min-w-full divide-y divide-white/5 text-sm'>
              <thead>
                <tr className='text-left text-xs uppercase tracking-[0.2em] text-ink-400'>
                  <th className='px-6 py-4'>Mã</th>
                  <th className='px-6 py-4'>Họ và tên</th>
                  <th className='px-6 py-4'>Điện thoại</th>
                  <th className='px-6 py-4'>Email</th>
                  <th className='px-6 py-4'>Trạng thái</th>
                  <th className='px-6 py-4'>Ngày tham gia</th>
                  <th className='px-6 py-4 text-right'>Thao tác</th>
                </tr>
              </thead>
              <tbody className='divide-y divide-white/5 text-ink-200'>
                {membersData.items.map(member => {
                  const statusStyles: Record<string, string> = {
                    ACTIVE: 'border-emerald-500/40 bg-emerald-500/10 text-emerald-200',
                    EXPIRED: 'border-red-500/40 bg-red-500/10 text-red-300',
                    SUSPENDED: 'border-amber-500/40 bg-amber-500/10 text-amber-200',
                  };

                  return (
                    <tr key={member.id} className='transition-colors duration-200 hover:bg-brand-500/5'>
                      <td className='px-6 py-4 font-mono text-xs text-ink-400'>#{member.id}</td>
                      <td className='px-6 py-4 text-brand-50'>{member.full_name}</td>
                      <td className='px-6 py-4'>
                        <span className='inline-flex items-center gap-2 text-sm text-ink-300'>
                          <Phone className='h-4 w-4 text-brand-300' strokeWidth={1.6} />
                          {member.phone}
                        </span>
                      </td>
                      <td className='px-6 py-4'>
                        <span className='inline-flex items-center gap-2 text-sm text-ink-300'>
                          <Mail className='h-4 w-4 text-brand-300' strokeWidth={1.6} />
                          {member.email}
                        </span>
                      </td>
                      <td className='px-6 py-4'>
                        <span className={`inline-flex rounded-full border px-3 py-1 text-xs font-semibold ${
                          statusStyles[member.membership_status] || 'border-white/10 bg-white/5 text-ink-200'
                        }`}>
                          {member.membership_status}
                        </span>
                      </td>
                      <td className='px-6 py-4 text-sm text-ink-300'>
                        {new Date(member.joined_at).toLocaleDateString('vi-VN')}
                      </td>
                      <td className='px-6 py-4 text-right'>
                        <div className='flex items-center justify-end gap-2'>
                          <button
                            type='button'
                            onClick={() => console.log('Edit', member.id)}
                            className='inline-flex items-center gap-2 rounded-xl border border-brand-500/30 px-3 py-2 text-xs font-semibold text-brand-200 transition-all duration-200 hover:border-brand-400 hover:bg-brand-500/10'
                          >
                            <Edit3 className='h-4 w-4' strokeWidth={1.6} />
                            Sửa
                          </button>
                          <button
                            type='button'
                            onClick={() => console.log('Delete', member.id)}
                            className='inline-flex items-center gap-2 rounded-xl border border-red-500/40 px-3 py-2 text-xs font-semibold text-red-300 transition-all duration-200 hover:bg-red-500/10'
                          >
                            <Trash2 className='h-4 w-4' strokeWidth={1.6} />
                            Xóa
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </Card>

      <div className='flex items-center justify-between gap-4 text-sm text-ink-300'>
        <Button
          variant='secondary'
          size='sm'
          disabled={page <= 1}
          onClick={() => setPage(prev => Math.max(1, prev - 1))}
        >
          Trang trước
        </Button>
        <span>
          Trang {Math.min(page, totalPages)} / {totalPages}
        </span>
        <Button
          variant='secondary'
          size='sm'
          disabled={page >= totalPages}
          onClick={() => setPage(prev => Math.min(totalPages, prev + 1))}
        >
          Trang tiếp theo
        </Button>
      </div>
    </div>
  );
}
