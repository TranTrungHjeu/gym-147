// Identity Service Prisma Schema - IoT Gym Management
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String?   @unique
  password_hash     String
  first_name        String
  last_name         String
  phone             String?   @unique
  role              Role      @default(MEMBER)
  is_active         Boolean   @default(true)
  email_verified    Boolean   @default(false)
  email_verified_at DateTime?
  phone_verified    Boolean   @default(false)
  phone_verified_at DateTime?
  last_login_at     DateTime?

  // Face Recognition Data
  face_encoding  Bytes? // Binary face data for better performance
  face_photo_url String? // Profile photo for face recognition

  // Push Notification
  push_token    String? // Expo/FCM Push Token
  push_enabled  Boolean @default(true)
  push_platform String? // "ios" | "android"

  // Notification Preferences
  email_notifications_enabled Boolean @default(true)
  sms_notifications_enabled   Boolean @default(false)

  // Security & Access
  two_factor_enabled    Boolean   @default(false)
  two_factor_secret     String?
  failed_login_attempts Int       @default(0)
  locked_until          DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  sessions               Session[]
  password_resets        PasswordReset[]
  access_logs            AccessLog[]
  ip_whitelists          IPWhitelist[]
  trusted_locations      TrustedLocation[]
  blocked_locations      BlockedLocation[]
  audit_logs             AuditLog[]
  notifications          Notification[]
  chat_messages_sent     ChatMessage[]     @relation("MessageSender")
  chat_messages_received ChatMessage[]     @relation("MessageReceiver")

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([role, is_active])
  @@index([last_login_at])
  @@index([created_at])
  @@index([phone_verified])
  @@index([push_token])
  @@map("users")
}

model Session {
  id            String   @id @default(cuid())
  user_id       String
  token         String   @unique
  refresh_token String?  @unique
  device_info   String? // Mobile/Web device info
  platform      Platform @default(WEB)
  expires_at    DateTime
  created_at    DateTime @default(now())
  last_used_at  DateTime @default(now())
  ip_address    String?
  user_agent    String?
  location      String? // Geo location if available

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([user_id])
  @@index([token])
  @@index([expires_at])
  @@index([platform, user_id])
  @@map("sessions")
}

model AccessLog {
  id             String       @id @default(cuid())
  user_id        String
  access_type    AccessType
  access_method  AccessMethod
  device_id      String? // RFID reader ID, QR scanner ID, etc.
  location       String? // Entry point location
  success        Boolean
  failure_reason String?
  timestamp      DateTime     @default(now())

  // IoT Integration
  sensor_data Json? @db.JsonB // PostgreSQL JSONB for better performance

  user User @relation(fields: [user_id], references: [id])

  // Indexes for performance
  @@index([user_id, timestamp])
  @@index([access_type, timestamp])
  @@index([device_id, timestamp])
  @@index([success, timestamp])
  @@index([location, timestamp])
  @@map("access_logs")
}

model PasswordReset {
  id         String    @id @default(cuid())
  user_id    String
  token      String    @unique
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([token])
  @@index([expires_at])
  @@index([user_id, created_at])
  @@map("password_resets")
}

model OTPVerification {
  id          String    @id @default(cuid())
  identifier  String // Email or phone number
  otp         String // Hashed OTP
  type        OTPType   @default(PHONE)
  attempts    Int       @default(0)
  expires_at  DateTime
  verified_at DateTime? // Track when OTP was successfully verified
  created_at  DateTime  @default(now())

  // Indexes for performance
  @@index([identifier, type])
  @@index([expires_at])
  @@index([verified_at])
  @@map("otp_verifications")
}

model IPWhitelist {
  id          String   @id @default(cuid())
  user_id     String
  ip_address  String
  description String?
  added_at    DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([ip_address])
  @@map("ip_whitelists")
}

model TrustedLocation {
  id        String   @id @default(cuid())
  user_id   String
  latitude  Float
  longitude Float
  address   String
  name      String?
  added_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("trusted_locations")
}

model BlockedLocation {
  id         String   @id @default(cuid())
  user_id    String
  latitude   Float
  longitude  Float
  address    String
  reason     String?
  blocked_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("blocked_locations")
}

model AuditLog {
  id          String   @id @default(cuid())
  user_id     String
  action      String
  entity_type String?
  entity_id   String?
  details     Json?
  ip_address  String?
  user_agent  String?
  timestamp   DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}

// EmailVerification model removed - using OTPVerification for all verification

// Cross-service references removed - not needed
// Member and Staff services have their own databases
// No need for reference tables in identity service

// Gym Membership - REMOVED: Not needed for single gym system
// User role and Member.membership_status already handle this

enum Role {
  SUPER_ADMIN
  ADMIN
  TRAINER
  MEMBER
}

enum Platform {
  WEB
  MOBILE_ANDROID
  MOBILE_IOS
  KIOSK
  RFID_READER
}

enum AccessType {
  LOGIN
  ENTRY
  EXIT
  EQUIPMENT_ACCESS
}

enum AccessMethod {
  PASSWORD
  RFID
  QR_CODE
  FACE_RECOGNITION
  FINGERPRINT
  MANUAL
}

enum OTPType {
  PHONE
  EMAIL
}

// Notifications - Centralized notification storage for all services
model Notification {
  id         String           @id @default(cuid())
  user_id    String // Reference to User
  type       NotificationType
  title      String
  message    String
  data       Json? // Additional data (booking_id, certification_id, trainer_id, member_id, etc.)
  is_read    Boolean          @default(false)
  read_at    DateTime?
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([user_id, is_read])
  @@index([user_id, created_at])
  @@index([type])
  @@index([is_read])
  @@index([created_at])
  @@index([is_read, created_at])
  @@map("notifications")
}

// Notification History - Track bulk notification sends
model NotificationHistory {
  id                String                 @id @default(cuid())
  sender_id         String // User who sent the notification
  sender_role       Role // Role of sender
  target_type       NotificationTargetType // MEMBER or TRAINER
  target_ids        Json? // Array of target IDs (member_ids or trainer_ids)
  filters           Json? // Filters used (membership_type, status, etc.)
  title             String
  message           String
  notification_type NotificationType       @default(GENERAL)
  sent_count        Int                    @default(0)
  failed_count      Int                    @default(0)
  total_targets     Int // Total number of targets
  created_at        DateTime               @default(now())

  // Indexes for performance
  @@index([sender_id])
  @@index([sender_role])
  @@index([target_type])
  @@index([created_at])
  @@index([sender_id, created_at])
  @@map("notification_historys")
}

enum NotificationTargetType {
  MEMBER
  TRAINER
}

enum NotificationType {
  // Certification related (for TRAINER, ADMIN, SUPER_ADMIN)
  CERTIFICATION_UPLOAD
  CERTIFICATION_VERIFIED
  CERTIFICATION_REJECTED
  CERTIFICATION_AUTO_VERIFIED
  CERTIFICATION_EXPIRED
  CERTIFICATION_PENDING
  CERTIFICATION_DELETED

  // Class/Booking related (for MEMBER, TRAINER, ADMIN)
  CLASS_BOOKING
  CLASS_CANCELLED
  CLASS_REMINDER
  CLASS_RATING
  WAITLIST_ADDED
  WAITLIST_PROMOTED
  SCHEDULE_CANCELLED
  SCHEDULE_CREATED
  SCHEDULE_UPDATED
  ROOM_CHANGED
  MEMBER_CHECKED_IN
  MEMBER_CHECKED_OUT
  BOOKING_UPDATED
  BOOKING_CANCELLED

  // Membership related (for MEMBER, ADMIN)
  MEMBERSHIP_EXPIRING
  MEMBERSHIP_EXPIRED
  MEMBERSHIP_RENEWED

  // Member related (for ADMIN, SUPER_ADMIN)
  MEMBER_REGISTERED
  MEMBER_UPDATED
  MEMBER_DELETED

  // Achievement/Reward related (for MEMBER)
  ACHIEVEMENT_UNLOCKED
  REWARD_REDEMPTION

  // Payment related (for MEMBER, ADMIN)
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  PAYMENT_REMINDER

  // Subscription related (for MEMBER, ADMIN)
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_EXPIRED
  SUBSCRIPTION_UPGRADED

  // Invoice related (for MEMBER, ADMIN)
  INVOICE_GENERATED
  INVOICE_OVERDUE

  // Queue related (for MEMBER, ADMIN)
  QUEUE_JOINED
  QUEUE_POSITION_UPDATED
  QUEUE_EXPIRED
  QUEUE_YOUR_TURN

  // Equipment related (for MEMBER, ADMIN)
  EQUIPMENT_AVAILABLE
  EQUIPMENT_MAINTENANCE_SCHEDULED
  EQUIPMENT_MAINTENANCE_COMPLETED

  // Trainer related (for ADMIN, MEMBER)
  TRAINER_DELETED

  // Issue reporting (for ADMIN, SUPER_ADMIN)
  ISSUE_REPORT

  // System
  SYSTEM_ANNOUNCEMENT
  GENERAL
}

// Chat Messages - Live chat support
model ChatMessage {
  id          String    @id @default(cuid())
  sender_id   String // User who sent the message
  receiver_id String? // User who receives (null for admin/staff support)
  message     String
  is_read     Boolean   @default(false)
  read_at     DateTime?
  created_at  DateTime  @default(now())

  sender   User  @relation("MessageSender", fields: [sender_id], references: [id], onDelete: Cascade)
  receiver User? @relation("MessageReceiver", fields: [receiver_id], references: [id], onDelete: Cascade)

  @@index([sender_id])
  @@index([receiver_id])
  @@index([sender_id, created_at])
  @@index([receiver_id, created_at])
  @@index([is_read])
  @@index([created_at])
  @@map("chat_messages")
}
