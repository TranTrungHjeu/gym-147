// Identity Service Prisma Schema - IoT Gym Management
generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}




model User {
  id                String    @id @default(cuid())
  email             String?   @unique
  password_hash     String
  first_name        String
  last_name         String
  phone             String?   @unique
  role              Role      @default(MEMBER)
  is_active         Boolean   @default(true)
  email_verified    Boolean   @default(false)
  email_verified_at DateTime?
  phone_verified    Boolean   @default(false)
  phone_verified_at DateTime?
  last_login_at     DateTime?
  
  // Face Recognition Data
  face_encoding     Bytes?    // Binary face data for better performance
  face_photo_url    String?   // Profile photo for face recognition
  
  // Push Notification
  push_token        String?   // Expo/FCM Push Token
  push_enabled      Boolean   @default(true)
  push_platform     String?   // "ios" | "android"
  
  // Security & Access
  two_factor_enabled Boolean  @default(false)
  two_factor_secret String?
  failed_login_attempts Int   @default(0)
  locked_until      DateTime?
  
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relations
  sessions          Session[]
  password_resets   PasswordReset[]
  access_logs       AccessLog[]
  member_profile    Member?   // One-to-one with member service
  staff_profile     Staff?    // One-to-one for staff members

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([role, is_active])
  @@index([last_login_at])
  @@index([created_at])
  @@index([phone_verified])
  @@index([push_token])
  @@map("users")
}

model Session {
  id             String   @id @default(cuid())
  user_id        String
  token          String   @unique
  refresh_token  String?  @unique
  device_info    String?  // Mobile/Web device info
  platform       Platform @default(WEB)
  expires_at     DateTime
  created_at     DateTime @default(now())
  last_used_at   DateTime @default(now())
  ip_address     String?
  user_agent     String?
  location       String?  // Geo location if available

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([user_id])
  @@index([token])
  @@index([expires_at])
  @@index([platform, user_id])
  @@map("sessions")
}

model AccessLog {
  id             String     @id @default(cuid())
  user_id        String
  access_type    AccessType
  access_method  AccessMethod
  device_id      String?    // RFID reader ID, QR scanner ID, etc.
  location       String?    // Entry point location
  success        Boolean
  failure_reason String?
  timestamp      DateTime   @default(now())
  
  // IoT Integration
  sensor_data    Json?      @db.JsonB // PostgreSQL JSONB for better performance
  
  user User @relation(fields: [user_id], references: [id])

  // Indexes for performance
  @@index([user_id, timestamp])
  @@index([access_type, timestamp])
  @@index([device_id, timestamp])
  @@index([success, timestamp])
  @@index([location, timestamp])
  @@map("access_logs")
}

model PasswordReset {
  id         String   @id @default(cuid())
  user_id    String
  token      String   @unique
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([token])
  @@index([expires_at])
  @@index([user_id, created_at])
  @@map("password_resets")
}

model OTPVerification {
  id          String     @id @default(cuid())
  identifier  String     // Email or phone number
  otp         String     // Hashed OTP
  type        OTPType    @default(PHONE)
  attempts    Int        @default(0)
  expires_at  DateTime
  verified_at DateTime?  // Track when OTP was successfully verified
  created_at  DateTime   @default(now())

  // Indexes for performance
  @@index([identifier, type])
  @@index([expires_at])
  @@index([verified_at])
  @@map("otp_verifications")
}

// EmailVerification model removed - using OTPVerification for all verification

// Cross-service references
model Member {
  id      String @id
  user_id String @unique
  user    User   @relation(fields: [user_id], references: [id])

  @@map("members_ref")
}

model Staff {
  id      String @id
  user_id String @unique
  user    User   @relation(fields: [user_id], references: [id])

  @@map("staff_ref")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  TRAINER
  MEMBER
}

enum Platform {
  WEB
  MOBILE_ANDROID
  MOBILE_IOS
  KIOSK
  RFID_READER
}

enum AccessType {
  LOGIN
  ENTRY
  EXIT
  EQUIPMENT_ACCESS
}

enum AccessMethod {
  PASSWORD
  RFID
  QR_CODE
  FACE_RECOGNITION
  FINGERPRINT
  MANUAL
}

enum OTPType {
  PHONE
  EMAIL
}