// Identity Service Prisma Schema - IoT Gym Management
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password_hash     String
  first_name        String
  last_name         String
  phone             String?   @unique
  role              Role      @default(MEMBER)
  is_active         Boolean   @default(true)
  email_verified    Boolean   @default(false)
  email_verified_at DateTime?
  last_login_at     DateTime?
  
  // Face Recognition Data
  face_encoding     String?   // Base64 encoded face data
  face_photo_url    String?   // Profile photo for face recognition
  
  // Security & Access
  two_factor_enabled Boolean  @default(false)
  two_factor_secret String?
  failed_login_attempts Int   @default(0)
  locked_until      DateTime?
  
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relations
  sessions          Session[]
  password_resets   PasswordReset[]
  access_logs       AccessLog[]
  member_profile    Member?   // One-to-one with member service
  staff_profile     Staff?    // One-to-one for staff members

  @@map("users")
}

model Session {
  id             String   @id @default(cuid())
  user_id        String
  token          String   @unique
  refresh_token  String?  @unique
  device_info    String?  // Mobile/Web device info
  platform       Platform @default(WEB)
  expires_at     DateTime
  created_at     DateTime @default(now())
  last_used_at   DateTime @default(now())
  ip_address     String?
  user_agent     String?
  location       String?  // Geo location if available

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model AccessLog {
  id             String     @id @default(cuid())
  user_id        String
  access_type    AccessType
  access_method  AccessMethod
  device_id      String?    // RFID reader ID, QR scanner ID, etc.
  location       String?    // Entry point location
  success        Boolean
  failure_reason String?
  timestamp      DateTime   @default(now())
  
  // IoT Integration
  sensor_data    Json?      // Additional sensor data
  
  user User @relation(fields: [user_id], references: [id])

  @@map("access_logs")
}

model PasswordReset {
  id         String   @id @default(cuid())
  user_id    String
  token      String   @unique
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// Cross-service references
model Member {
  id      String @id
  user_id String @unique
  user    User   @relation(fields: [user_id], references: [id])

  @@map("members_ref")
}

model Staff {
  id      String @id
  user_id String @unique
  user    User   @relation(fields: [user_id], references: [id])

  @@map("staff_ref")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  TRAINER
  NUTRITIONIST
  RECEPTIONIST
  MAINTENANCE
  MEMBER
}

enum Platform {
  WEB
  MOBILE_ANDROID
  MOBILE_IOS
  KIOSK
  RFID_READER
}

enum AccessType {
  LOGIN
  ENTRY
  EXIT
  EQUIPMENT_ACCESS
}

enum AccessMethod {
  PASSWORD
  RFID
  QR_CODE
  FACE_RECOGNITION
  FINGERPRINT
  MANUAL
}