// Billing Service Prisma Schema - IoT Gym Management
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model MembershipPlan {
  id                String              @id @default(cuid())
  name              String              @unique
  description       String?
  type              PlanType
  duration_months   Int                 // Plan duration
  price             Decimal             @db.Decimal(10, 2)
  
  // Access and Benefits
  benefits          String[]            // Array of benefits
  smart_workout_plans Boolean          @default(false) // AI-generated plans
  
  // Plan Management
  is_active         Boolean             @default(true)
  is_featured       Boolean             @default(false)
  
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt

  // Relations
  subscriptions     Subscription[]

  @@map("membership_plans")
}

model Subscription {
  id                String             @id @default(cuid())
  member_id         String             @unique // Reference to member service
  plan_id           String
  
  // Subscription Details
  status            SubscriptionStatus @default(ACTIVE)
  start_date        DateTime
  end_date          DateTime?
  next_billing_date DateTime
  current_period_start DateTime
  current_period_end DateTime
  
  // Pricing and Discounts
  base_amount       Decimal            @db.Decimal(10, 2)
  discount_amount   Decimal?           @db.Decimal(10, 2)
  total_amount      Decimal            @db.Decimal(10, 2)
  
  // Billing
  failed_payments   Int                @default(0)
  
  // Cancellation
  cancelled_at      DateTime?
  cancellation_reason String?
  cancelled_by      String?            // Member ID or Staff ID
  
  // Trial Information
  trial_start       DateTime?
  trial_end         DateTime?
  
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt

  // Relations
  plan              MembershipPlan     @relation(fields: [plan_id], references: [id])
  payments          Payment[]

  @@map("subscriptions")
}

model Payment {
  id                String            @id @default(cuid())
  subscription_id   String?
  member_id         String            // Reference to member service
  
  // Payment Details
  amount            Decimal           @db.Decimal(10, 2)
  currency          String            @default("VND")
  status            PaymentStatus     @default(PENDING)
  payment_method    PaymentMethod
  net_amount        Decimal           @db.Decimal(10, 2)
  
  // Payment Context
  payment_type      PaymentType
  reference_id      String?           // Booking ID, invoice ID, etc. (for CLASS_BOOKING, ADDON_PURCHASE, etc.)
  description       String?           // Payment description
  
  // Processing
  processed_at      DateTime?
  failed_at         DateTime?
  failure_reason    String?
  retry_count       Int               @default(0)
  
  // Refunds
  refunded_amount   Decimal?          @db.Decimal(10, 2)
  
  // Metadata for additional data (JSON)
  metadata          Json?             // Store additional metadata like reward_redemption_id, etc.
  
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  // Relations
  subscription      Subscription?     @relation(fields: [subscription_id], references: [id])
  refunds           Refund[]
  bank_transfer     BankTransfer?     // One-to-one for bank transfer payments

  @@index([reference_id])
  @@index([payment_type, reference_id])
  @@map("payments")
}

model Refund {
  id            String       @id @default(cuid())
  payment_id    String
  amount        Decimal      @db.Decimal(10, 2)
  reason        RefundReason
  status        RefundStatus @default(PENDING)
  
  // Processing
  transaction_id String?     // Gateway refund transaction ID
  processed_at  DateTime?
  failed_at     DateTime?
  failure_reason String?
  
  // Authorization
  requested_by  String       // Staff/System ID
  approved_by   String?      // Manager ID
  notes         String?
  
  // Metadata for timeline tracking
  metadata      Json?        // Store timeline and additional data
  
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  // Relations
  payment       Payment      @relation(fields: [payment_id], references: [id])

  @@map("refunds")
}

model BankTransfer {
  id                String            @id @default(cuid())
  payment_id        String            @unique // Link to Payment record
  member_id         String            // Reference to member service
  
  // Transfer Details
  transfer_content  String            // Expected transfer content with code
  amount            Decimal           @db.Decimal(10, 2)
  status            BankTransferStatus @default(PENDING)
  
  // Bank Account Information
  bank_name         String            // e.g., "VietcomBank"
  bank_code         String            // e.g., "VCB"
  account_number    String            // Bank account number
  account_name      String            // Account holder name
  
  // QR Code
  qr_code_url       String?           // QR code for quick transfer
  qr_data           String?           // QR code data string
  
  // Sepay Integration
  sepay_transaction_id String?        @unique // Transaction ID from Sepay
  
  // Verification
  verified_at       DateTime?
  verified_amount   Decimal?          @db.Decimal(10, 2)
  verified_content  String?           // Actual transfer content received
  
  // Timing
  expires_at        DateTime          // Transfer must complete before this
  completed_at      DateTime?
  
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  // Relations
  payment           Payment           @relation(fields: [payment_id], references: [id])

  @@map("bank_transfers")
  @@index([member_id])
  @@index([status])
  @@index([sepay_transaction_id])
}

model DiscountCode {
  id                String          @id @default(cuid())
  code              String          @unique
  name              String
  description       String?
  
  // Discount Configuration
  type              DiscountType
  value             Decimal         @db.Decimal(10, 2) // Amount or percentage
  max_discount      Decimal?        @db.Decimal(10, 2) // Max discount for percentage
  
  // Usage Limits
  usage_limit       Int?            // Total usage limit
  usage_count       Int             @default(0)
  usage_limit_per_member Int?       // Per-member usage limit
  
  // Validity
  valid_from        DateTime
  valid_until       DateTime?
  is_active         Boolean         @default(true)
  
  // Applicability
  applicable_plans  String[]        // Plan IDs this code applies to
  minimum_amount    Decimal?        @db.Decimal(10, 2)
  first_time_only   Boolean         @default(false)
  
  // Referral System (Improved)
  referrer_member_id String?        // Member who created referral code
  bonus_days        Int?            // Bonus days for referee (người được giới thiệu)
  referral_reward   Decimal?        @db.Decimal(10, 2) // Reward for referrer
  
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt

  // Relations
  usage_history     DiscountUsage[]

  @@map("discount_codes")
}

model DiscountUsage {
  id               String       @id @default(cuid())
  discount_code_id String
  member_id        String       // Reference to member service (referee)
  subscription_id  String?
  amount_discounted Decimal     @db.Decimal(10, 2)
  bonus_days_added Int?         // Bonus days added from referral
  referrer_member_id String?    // Referrer who gets reward
  referrer_reward  Decimal?     @db.Decimal(10, 2) // Reward given to referrer
  used_at          DateTime     @default(now())

  discount_code DiscountCode @relation(fields: [discount_code_id], references: [id])

  @@map("discount_usage")
}

// Gym Revenue Analytics
model RevenueReport {
  id              String   @id @default(cuid())
  report_date     DateTime @unique
  
  // Daily Revenue Breakdown
  subscription_revenue Decimal @db.Decimal(12, 2) @default(0)
  class_revenue   Decimal  @db.Decimal(12, 2) @default(0)
  addon_revenue   Decimal  @db.Decimal(12, 2) @default(0)
  other_revenue   Decimal  @db.Decimal(12, 2) @default(0)
  total_revenue   Decimal  @db.Decimal(12, 2) @default(0)
  
  // Membership Metrics
  new_members     Int      @default(0)
  cancelled_members Int    @default(0)
  active_members  Int      @default(0)
  
  // Payment Metrics
  successful_payments Int  @default(0)
  failed_payments Int      @default(0)
  refunds_issued  Int      @default(0)
  refunds_amount  Decimal  @db.Decimal(10, 2) @default(0)
  
  created_at      DateTime @default(now())

  @@map("revenue_reports")
}

// Subscription History Tracking (Improved)
model SubscriptionHistory {
  id              String   @id @default(cuid())
  subscription_id String
  member_id       String   // Reference to member service
  
  // Change Details
  from_plan_id    String?  // Previous plan (null if first subscription)
  to_plan_id      String   // New plan
  from_status     SubscriptionStatus?
  to_status       SubscriptionStatus
  
  // Pricing
  old_price       Decimal? @db.Decimal(10, 2)
  new_price       Decimal  @db.Decimal(10, 2)
  price_difference Decimal @db.Decimal(10, 2) // Positive = charge more, Negative = refund
  
  // Metadata
  change_reason   String?  // "UPGRADE", "DOWNGRADE", "RENEWAL", "CANCELLATION"
  changed_by      String?  // member_id/staff_id/system
  notes           String?
  
  created_at      DateTime @default(now())

  @@map("subscription_history")
  @@index([subscription_id])
  @@index([member_id])
}

// Enums
enum PlanType {
  BASIC     // Gói cơ bản - 299k/tháng
  PREMIUM   // Gói phổ biến - 599k/tháng
  VIP       // Gói cao cấp - 999k/tháng
  STUDENT   // Gói sinh viên - 199k/tháng
  // Note: TRIAL, SENIOR, FAMILY, CORPORATE, DAY_PASS được xử lý qua DiscountCode/Addon
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
  SUSPENDED
  PENDING
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  VNPAY
  MOMO
  ZALO_PAY
  CASH
  CRYPTO
}

enum PaymentType {
  SUBSCRIPTION
  CLASS_BOOKING
  ADDON_PURCHASE
  LATE_FEE
  EQUIPMENT_DAMAGE
  // GUEST_PASS removed
  OTHER
}

enum RefundReason {
  MEMBER_REQUEST
  SERVICE_ISSUE
  BILLING_ERROR
  CANCELLATION
  EQUIPMENT_ISSUE
  CLASS_CANCELLED
  OTHER
}

enum RefundStatus {
  PENDING
  APPROVED
  PROCESSED
  FAILED
  REJECTED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_TRIAL
  FIRST_MONTH_FREE
}

enum BankTransferStatus {
  PENDING         // Waiting for transfer
  CHECKING        // Checking transaction with Sepay
  VERIFIED        // Transfer confirmed by Sepay
  COMPLETED       // Payment processed
  EXPIRED         // Transfer window expired
  FAILED          // Verification failed
  CANCELLED       // Cancelled by user
}